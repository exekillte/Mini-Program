<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF æå–å™¨ (é¡ºåºé‡æ’ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --border: #333333;
            --text-main: #e0e0e0;
            --text-dim: #888888;
            --primary: #3b82f6;
            --badge-bg: #ef4444; /* çº¢è‰²è§’æ ‡ï¼Œæ›´æ˜¾çœ¼ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-info h1 { margin: 0; font-size: 18px; font-weight: 600; }
        .header-info p { margin: 4px 0 0 0; font-size: 12px; color: var(--text-dim); }

        /* æ‹–æ‹½åŒº */
        .drop-zone {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: #1a1a1a;
            transition: all 0.2s;
        }
        .drop-zone:hover, .drop-zone.drag-over { border-color: var(--primary); background: #222; }

        /* å·¥å…·æ  */
        .toolbar {
            display: none;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 20px;
            gap: 15px;
            align-items: center;
            position: sticky;
            top: 10px;
            z-index: 100;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        .status-text { font-size: 13px; color: var(--text-dim); flex: 1; }
        .status-text b { color: var(--primary); margin-right: 4px; }

        button {
            background: #333; color: var(--text-main); border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;
        }
        button:hover { background: #444; }
        button.primary { background: var(--primary); border-color: var(--primary); color: white; }
        button.primary:hover { background: #2563eb; }

        /* ç½‘æ ¼æ’ç‰ˆä¿®æ­£ï¼šä½¿ç”¨ Grid å¸ƒå±€ï¼Œä¿è¯å•å…ƒæ ¼å¤§å°ä¸€è‡´ */
        .grid-container {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 10px;
            padding-bottom: 40px;
        }

        .page-card {
            background: #252525;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            transition: transform 0.1s, border-color 0.1s;
            display: flex;
            flex-direction: column;
        }
        .page-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        /* é€‰ä¸­çŠ¶æ€ */
        .page-card.selected {
            border-color: var(--primary);
            background: #2a2a2a;
        }

        /* é¡ºåºè§’æ ‡ */
        .order-badge {
            display: none;
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .page-card.selected .order-badge { display: flex; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* å›¾ç‰‡å®¹å™¨ï¼šå›ºå®šé«˜åº¦ï¼Œå†…å®¹å±…ä¸­ï¼Œé¿å…é•¿å®½æ¯”æ··ä¹± */
        .thumb-container {
            height: 200px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #333; /* ç¼©ç•¥å›¾èƒŒæ™¯åº•è‰² */
            padding: 10px;
            box-sizing: border-box;
        }
        .page-thumb {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .page-meta {
            background: #1e1e1e;
            color: var(--text-dim);
            padding: 8px;
            text-align: center;
            font-size: 12px;
            border-top: 1px solid #333;
            margin-top: auto; /* ä¿è¯å…ƒæ•°æ®æ€»åœ¨åº•éƒ¨ */
        }
        .page-card.selected .page-meta { background: var(--primary); color: white; }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        .loader { display: none; margin: 40px auto; color: var(--text-dim); font-size: 14px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="header-info">
            <h1>PDF æå–å™¨ <span style="font-size:12px; background:#333; padding:2px 6px; border-radius:4px; margin-left:8px;">é¡ºåºé‡æ’ç‰ˆ</span></h1>
            <p>ç‚¹å‡»é¡ºåºå³ä¸ºå¯¼å‡ºé¡ºåº Â· çº¯æœ¬åœ°è¿è¡Œ</p>
        </div>
        <button onclick="document.getElementById('file-input').click()">é€‰æ‹©æ–‡ä»¶</button>
    </div>

    <div id="drop-zone" class="drop-zone">
        <div style="font-size: 32px; color: #555; margin-bottom:10px;">ğŸ“„</div>
        <div class="drop-hint">æ‹–å…¥ PDF æ–‡ä»¶</div>
    </div>
    
    <input type="file" id="file-input" style="display:none" accept=".pdf">

    <div id="loader" class="loader">æ­£åœ¨è§£æé¡µé¢ï¼Œå¤§æ–‡ä»¶è¯·ç¨å€™...</div>

    <div id="toolbar" class="toolbar">
        <div class="status-text">å·²é€‰æ‹© <b id="count-display">0</b> é¡µ</div>
        <button onclick="clearSelection()">é‡ç½®é€‰æ‹©</button>
        <button class="primary" onclick="exportPDF()">æŒ‰é¡ºåºå¯¼å‡º PDF</button>
    </div>

    <div id="grid" class="grid-container"></div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const els = {
        drop: document.getElementById('drop-zone'),
        input: document.getElementById('file-input'),
        grid: document.getElementById('grid'),
        toolbar: document.getElementById('toolbar'),
        loader: document.getElementById('loader'),
        countDisplay: document.getElementById('count-display')
    };

    let currentFile = null;
    let pdfDoc = null;
    let totalPages = 0;
    // æ ¸å¿ƒçŠ¶æ€ï¼šä½¿ç”¨æ•°ç»„å­˜å‚¨é€‰æ‹©çš„é¡µç ï¼Œæ•°ç»„çš„é¡ºåºå°±æ˜¯å¯¼å‡ºçš„é¡ºåº
    let selectedQueue = []; 

    // --- äº¤äº’åˆå§‹åŒ– ---
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
        document.body.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
    });
    els.drop.addEventListener('drop', (e) => {
        if (e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]);
    });
    els.input.addEventListener('change', e => {
        if (e.target.files.length) loadFile(e.target.files[0]);
    });

    // --- åŠ è½½ PDF ---
    async function loadFile(file) {
        if (file.type !== 'application/pdf') return alert('è¯·ä¸Šä¼  PDF');
        currentFile = file;
        
        els.drop.style.display = 'none';
        els.loader.style.display = 'block';
        els.grid.innerHTML = '';
        selectedQueue = [];
        updateUI();

        try {
            const arrayBuffer = await file.arrayBuffer();
            pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
            totalPages = pdfDoc.getPageCount();

            const loadingTask = pdfjsLib.getDocument(new Uint8Array(arrayBuffer));
            const pdfRenderer = await loadingTask.promise;

            els.loader.style.display = 'none';
            els.grid.style.display = 'grid';
            els.toolbar.style.display = 'flex';

            for (let i = 1; i <= totalPages; i++) {
                renderThumbnail(pdfRenderer, i);
            }
        } catch (err) {
            console.error(err);
            alert('è§£æå¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸåæˆ–åŠ å¯†');
            location.reload();
        }
    }

    // --- æ¸²æŸ“ç¼©ç•¥å›¾ ---
    async function renderThumbnail(pdf, pageNum) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 0.3 }); // é™ä½åˆ†è¾¨ç‡æå‡æ€§èƒ½

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({ canvasContext: context, viewport: viewport }).promise;

        const card = document.createElement('div');
        card.className = 'page-card';
        card.id = `card-${pageNum}`;
        card.onclick = () => togglePage(pageNum);

        // é¡ºåºè§’æ ‡
        const badge = document.createElement('div');
        badge.className = 'order-badge';
        badge.id = `badge-${pageNum}`;
        
        // ç¼©ç•¥å›¾å®¹å™¨
        const thumbBox = document.createElement('div');
        thumbBox.className = 'thumb-container';
        const img = document.createElement('img');
        img.src = canvas.toDataURL();
        img.className = 'page-thumb';
        thumbBox.appendChild(img);

        // é¡µç æ¡
        const meta = document.createElement('div');
        meta.className = 'page-meta';
        meta.textContent = `åŸç¬¬ ${pageNum} é¡µ`;

        card.appendChild(badge);
        card.appendChild(thumbBox);
        card.appendChild(meta);
        els.grid.appendChild(card);
    }

    // --- æ ¸å¿ƒé€»è¾‘ï¼šç‚¹å‡»é€‰æ‹©ä¸æ’åº ---
    function togglePage(pageNum) {
        const index = selectedQueue.indexOf(pageNum);
        
        if (index === -1) {
            // æ–°å¢ï¼šåŠ å…¥é˜Ÿåˆ—æœ«å°¾
            selectedQueue.push(pageNum);
        } else {
            // å–æ¶ˆï¼šä»é˜Ÿåˆ—ä¸­ç§»é™¤
            selectedQueue.splice(index, 1);
        }
        
        refreshBadges();
        updateUI();
    }

    // åˆ·æ–°æ‰€æœ‰é€‰ä¸­å¡ç‰‡çš„æ•°å­—è§’æ ‡
    function refreshBadges() {
        // å…ˆæ¸…ç©ºæ‰€æœ‰æ ·å¼
        document.querySelectorAll('.page-card').forEach(c => c.classList.remove('selected'));
        
        // é‡æ–°åº”ç”¨æ ·å¼å’Œæ•°å­—
        selectedQueue.forEach((pageNum, idx) => {
            const card = document.getElementById(`card-${pageNum}`);
            const badge = document.getElementById(`badge-${pageNum}`);
            if (card && badge) {
                card.classList.add('selected');
                badge.textContent = idx + 1; // æ˜¾ç¤º 1, 2, 3...
            }
        });
    }

    function clearSelection() {
        selectedQueue = [];
        refreshBadges();
        updateUI();
    }

    function updateUI() {
        els.countDisplay.textContent = selectedQueue.length;
    }

    // --- å¯¼å‡ºé€»è¾‘ ---
    async function exportPDF() {
        if (selectedQueue.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡µ');

        const newPdf = await PDFLib.PDFDocument.create();
        
        // å…³é”®ï¼šç›´æ¥æŒ‰ç…§ selectedQueue (ä½ çš„ç‚¹å‡»é¡ºåº) æ¥å¤åˆ¶é¡µé¢
        // PDFLib ä½¿ç”¨ 0-basedç´¢å¼•ï¼Œæ‰€ä»¥è¦å‡1
        const indices = selectedQueue.map(p => p - 1);
        
        // copyPages æ”¯æŒæŒ‰æ•°ç»„é¡ºåºè¿”å›é¡µé¢
        const copiedPages = await newPdf.copyPages(pdfDoc, indices);
        
        copiedPages.forEach(page => newPdf.addPage(page));

        const pdfBytes = await newPdf.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        
        const originalName = currentFile.name.replace(/\.pdf$/i, "");
        saveAs(blob, `${originalName}_é‡æ’ç‰ˆ.pdf`);
    }
</script>

</body>
</html>
