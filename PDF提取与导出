<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF æå–ä¸é‡ç»„å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --border: #333333;
            --text-main: #e0e0e0;
            --text-dim: #888888;
            --primary: #3b82f6;
            --badge-bg: #ef4444; 
            --success: #10b981;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* é¡¶éƒ¨å¡ç‰‡ */
        .header-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-info h1 { margin: 0; font-size: 18px; font-weight: 600; }
        .header-info p { margin: 4px 0 0 0; font-size: 12px; color: var(--text-dim); }

        /* æ‹–æ‹½åŒº */
        .drop-zone {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            background: #1a1a1a;
            transition: all 0.2s;
        }
        .drop-zone:hover, .drop-zone.drag-over { border-color: var(--primary); background: #222; }

        /* å·¥å…·æ  */
        .toolbar {
            display: none;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 20px;
            gap: 10px;
            align-items: center;
            position: sticky;
            top: 10px;
            z-index: 100;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
            flex-wrap: wrap;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            background: #333; color: var(--text-main); border: 1px solid var(--border);
            padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;
            transition: background 0.1s;
        }
        button:hover { background: #444; }
        button:active { transform: translateY(1px); }
        
        button.primary { background: var(--primary); border-color: var(--primary); color: white; }
        button.primary:hover { background: #2563eb; }
        
        button.text-btn { background: transparent; border: none; color: var(--text-dim); }
        button.text-btn:hover { color: var(--text-main); background: transparent; }

        /* æ¨¡å¼åˆ‡æ¢å¼€å…³ */
        .mode-switch {
            display: flex;
            background: #2a2a2a;
            border-radius: 6px;
            padding: 3px;
            margin-right: auto; /* æ¨åˆ°å·¦è¾¹ */
        }
        .mode-option {
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            color: var(--text-dim);
            user-select: none;
        }
        .mode-option.active {
            background: #444;
            color: white;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* ç½‘æ ¼ç³»ç»Ÿ */
        .grid-container {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 10px;
            padding-bottom: 40px;
        }

        .page-card {
            background: #252525;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            transition: transform 0.1s;
        }
        .page-card:hover { border-color: #555; }
        
        /* é€‰ä¸­çŠ¶æ€ */
        .page-card.selected {
            border-color: var(--primary);
            background: #2a2a2a;
        }

        /* é¡ºåºè§’æ ‡/é€‰ä¸­æ ‡è®° */
        .order-badge {
            display: none;
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--primary);
            color: white;
            min-width: 24px;
            height: 24px;
            border-radius: 12px; /* æ¤­åœ†é€‚åº”å¤šä½æ•° */
            padding: 0 6px;
            box-sizing: border-box;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }
        /* åŸé¡ºåºæ¨¡å¼ä¸‹çš„æ ‡è®°é¢œè‰² */
        .page-card.selected.mode-origin .order-badge {
            background: var(--success);
        }

        .page-card.selected .order-badge { display: flex; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        .thumb-container {
            height: 180px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #333;
            padding: 10px;
            box-sizing: border-box;
        }
        .page-thumb {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .page-card.selected .page-thumb { opacity: 1; }

        .page-meta {
            background: #1e1e1e;
            color: var(--text-dim);
            padding: 6px;
            text-align: center;
            font-size: 11px;
            border-top: 1px solid #333;
            margin-top: auto;
        }
        .page-card.selected .page-meta { background: #333; color: white; }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        .loader { display: none; margin: 40px auto; color: var(--text-dim); font-size: 14px; text-align: center; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="header-info">
            <h1>PDF é¡µé¢æå–ä¸é‡æ’</h1>
            <p>çº¯æœ¬åœ°è¿è¡Œï¼Œæ•°æ®ä¸ä¸Šä¼ </p>
        </div>
        <button onclick="document.getElementById('file-input').click()">å¯¼å…¥ PDF æ–‡ä»¶</button>
    </div>

    <div id="drop-zone" class="drop-zone">
        <div style="font-size: 32px; color: #555; margin-bottom:10px;">ğŸ“„</div>
        <div class="drop-hint">æ‹–å…¥ PDF æ–‡ä»¶</div>
    </div>
    
    <input type="file" id="file-input" style="display:none" accept=".pdf">

    <div id="loader" class="loader">æ­£åœ¨æŒ‰é¡ºåºè§£æé¡µé¢ï¼Œè¯·ç¨å€™...</div>

    <div id="toolbar" class="toolbar">
        <!-- æ¨¡å¼åˆ‡æ¢ -->
        <div class="mode-switch">
            <div id="mode-click" class="mode-option active" onclick="setMode('click')">æŒ‰ç‚¹å‡»é¡ºåºå¯¼å‡º</div>
            <div id="mode-origin" class="mode-option" onclick="setMode('origin')">æŒ‰åŸæ–‡æ¡£é¡µç å¯¼å‡º</div>
        </div>

        <div style="height: 20px; width: 1px; background: #333; margin: 0 10px;"></div>

        <button class="text-btn" onclick="selectAll()">å…¨é€‰</button>
        <button class="text-btn" onclick="invertSelection()">åé€‰</button>
        <button class="text-btn" onclick="clearSelection()">æ¸…ç©º</button>

        <div style="height: 20px; width: 1px; background: #333; margin: 0 10px;"></div>
        
        <span style="font-size: 12px; color: #888;">å·²é€‰ <b id="count-display" style="color: var(--primary)">0</b> é¡µ</span>
        <button class="primary" onclick="exportPDF()">å¯¼å‡ºæ–° PDF</button>
    </div>

    <div id="grid" class="grid-container"></div>
</div>

<script>
    // é…ç½® PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const els = {
        drop: document.getElementById('drop-zone'),
        input: document.getElementById('file-input'),
        grid: document.getElementById('grid'),
        toolbar: document.getElementById('toolbar'),
        loader: document.getElementById('loader'),
        countDisplay: document.getElementById('count-display'),
        modeClick: document.getElementById('mode-click'),
        modeOrigin: document.getElementById('mode-origin')
    };

    let currentFile = null;
    let pdfDoc = null;
    let totalPages = 0;
    
    // selectedQueue å­˜å‚¨è¢«é€‰ä¸­çš„é¡µç  (1-based)
    // é¡ºåºå³ä¸ºç”¨æˆ·ç‚¹å‡»çš„é¡ºåº
    let selectedQueue = []; 
    
    // å¯¼å‡ºæ¨¡å¼: 'click' (ç‚¹å‡»é¡ºåº) | 'origin' (åŸæ–‡æ¡£é¡ºåº)
    let exportMode = 'click';

    // --- äº¤äº’åˆå§‹åŒ– ---
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
        document.body.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
    });
    els.drop.addEventListener('drop', (e) => {
        if (e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]);
    });
    els.input.addEventListener('change', e => {
        if (e.target.files.length) loadFile(e.target.files[0]);
    });

    // --- æ ¸å¿ƒé€»è¾‘ 1: åŠ è½½ä¸é¢„å ä½ (è§£å†³ä¹±åºé—®é¢˜) ---
    async function loadFile(file) {
        if (file.type !== 'application/pdf') return alert('è¯·ä¸Šä¼  PDF');
        currentFile = file;
        
        // é‡ç½®çŠ¶æ€
        els.drop.style.display = 'none';
        els.loader.style.display = 'block';
        els.toolbar.style.display = 'none'; // å…ˆéšè—å·¥å…·æ 
        els.grid.innerHTML = '';
        selectedQueue = [];
        updateUI();

        try {
            const arrayBuffer = await file.arrayBuffer();
            // PDFLib ç”¨äºåç»­å¯¼å‡º
            pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
            totalPages = pdfDoc.getPageCount();

            // PDF.js ç”¨äºæ¸²æŸ“ç¼©ç•¥å›¾
            const loadingTask = pdfjsLib.getDocument(new Uint8Array(arrayBuffer));
            const pdfRenderer = await loadingTask.promise;

            els.loader.style.display = 'none';
            els.grid.style.display = 'grid';
            els.toolbar.style.display = 'flex';

            // [å…³é”®æ­¥éª¤]ï¼šå…ˆåŒæ­¥åˆ›å»ºæ‰€æœ‰çš„ç©ºå£³å®¹å™¨ã€‚
            // è¿™æ ·æ— è®ºå›¾ç‰‡åŠ è½½å¿«æ…¢ï¼Œå®¹å™¨çš„é¡ºåºæ°¸è¿œæ˜¯ 1, 2, 3...
            for (let i = 1; i <= totalPages; i++) {
                createPlaceholder(i);
            }

            // ç„¶åå†å¼‚æ­¥å»å¡«å……è¿™äº›å®¹å™¨
            for (let i = 1; i <= totalPages; i++) {
                // ä¸ä½¿ç”¨ await é˜»å¡å¾ªç¯ï¼Œè®©å®ƒä»¬å¹¶å‘åŠ è½½ï¼Œä½†ä½ç½®å·²ç»å›ºå®š
                renderThumbnail(pdfRenderer, i);
            }

        } catch (err) {
            console.error(err);
            alert('è§£æå¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸåæˆ–åŠ å¯†');
            location.reload();
        }
    }

    // åˆ›å»ºç©ºå£³å¡ç‰‡
    function createPlaceholder(pageNum) {
        const card = document.createElement('div');
        card.className = 'page-card';
        card.id = `card-${pageNum}`; // å”¯ä¸€IDç”¨äºåç»­æŸ¥æ‰¾
        card.onclick = () => togglePage(pageNum);

        // å†…éƒ¨ç»“æ„
        card.innerHTML = `
            <div class="order-badge" id="badge-${pageNum}"></div>
            <div class="thumb-container" id="thumb-box-${pageNum}">
                <!-- å›¾ç‰‡ç¨ååŠ è½½ -->
                <div style="color:#555; font-size:12px;">åŠ è½½ä¸­...</div>
            </div>
            <div class="page-meta">ç¬¬ ${pageNum} é¡µ</div>
        `;
        
        els.grid.appendChild(card);
    }

    // æ¸²æŸ“ç¼©ç•¥å›¾å¹¶æ”¾å…¥å¯¹åº”å£³å­
    async function renderThumbnail(pdf, pageNum) {
        try {
            const page = await pdf.getPage(pageNum);
            // ç¼©æ”¾æ¯”ä¾‹ï¼Œ0.2-0.3 è¶³å¤Ÿç¼©ç•¥å›¾æ¸…æ™°åº¦ï¼Œè¿‡å¤§ä¼šå¡é¡¿
            const viewport = page.getViewport({ scale: 0.25 }); 

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport: viewport }).promise;

            const img = document.createElement('img');
            img.src = canvas.toDataURL();
            img.className = 'page-thumb';
            
            // æ‰¾åˆ°å¯¹åº”çš„å®¹å™¨å¹¶æ›¿æ¢å†…å®¹
            const thumbBox = document.getElementById(`thumb-box-${pageNum}`);
            if (thumbBox) {
                thumbBox.innerHTML = ''; // æ¸…é™¤"åŠ è½½ä¸­"
                thumbBox.appendChild(img);
            }
        } catch (e) {
            console.error(`Page ${pageNum} render error`, e);
        }
    }

    // --- æ ¸å¿ƒé€»è¾‘ 2: é€‰æ‹©ä¸çŠ¶æ€ç®¡ç† ---

    function setMode(mode) {
        exportMode = mode;
        
        // æ›´æ–°æŒ‰é’®æ ·å¼
        if (mode === 'click') {
            els.modeClick.classList.add('active');
            els.modeOrigin.classList.remove('active');
        } else {
            els.modeClick.classList.remove('active');
            els.modeOrigin.classList.add('active');
        }
        
        // åˆ·æ–°UIæ˜¾ç¤ºï¼ˆå› ä¸ºè§’æ ‡æ ·å¼å˜äº†ï¼‰
        refreshBadges();
    }

    function togglePage(pageNum) {
        const index = selectedQueue.indexOf(pageNum);
        
        if (index === -1) {
            selectedQueue.push(pageNum);
        } else {
            selectedQueue.splice(index, 1);
        }
        
        refreshBadges();
        updateUI();
    }

    function selectAll() {
        selectedQueue = [];
        for (let i = 1; i <= totalPages; i++) {
            selectedQueue.push(i);
        }
        refreshBadges();
        updateUI();
    }

    function invertSelection() {
        const newQueue = [];
        for (let i = 1; i <= totalPages; i++) {
            if (!selectedQueue.includes(i)) {
                newQueue.push(i);
            }
        }
        // åé€‰åçš„é¡ºåºï¼šé€šå¸¸æŒ‰ä»å°åˆ°å¤§ï¼Œå› ä¸ºåé€‰é€»è¾‘æœ¬èº«æ˜¯æŒ‰é¡ºåºéå†çš„
        selectedQueue = newQueue;
        refreshBadges();
        updateUI();
    }

    function clearSelection() {
        selectedQueue = [];
        refreshBadges();
        updateUI();
    }

    // åˆ·æ–°è§†è§‰çŠ¶æ€ï¼ˆè§’æ ‡ä¸è¾¹æ¡†ï¼‰
    function refreshBadges() {
        // 1. æ¸…ç†æ—§çŠ¶æ€
        document.querySelectorAll('.page-card').forEach(c => {
            c.classList.remove('selected', 'mode-origin');
        });
        document.querySelectorAll('.order-badge').forEach(b => {
            b.innerText = '';
        });
        
        // 2. å†³å®šæ’åºé€»è¾‘ç”¨äºæ˜¾ç¤º
        // å¦‚æœæ˜¯ origin æ¨¡å¼ï¼Œæˆ‘ä»¬è¦ä¸è¦æ˜¾ç¤ºç‚¹å‡»é¡ºåºï¼Ÿ
        // é€»è¾‘ï¼šå¦‚æœ origin æ¨¡å¼ï¼Œæ˜¾ç¤º "âœ“"ï¼›å¦‚æœ click æ¨¡å¼ï¼Œæ˜¾ç¤º "1, 2, 3"
        
        selectedQueue.forEach((pageNum, idx) => {
            const card = document.getElementById(`card-${pageNum}`);
            const badge = document.getElementById(`badge-${pageNum}`);
            
            if (card && badge) {
                card.classList.add('selected');
                
                if (exportMode === 'origin') {
                    card.classList.add('mode-origin');
                    badge.innerHTML = 'âœ“'; // ç®€å•çš„æ‰“é’©
                } else {
                    badge.textContent = idx + 1; // æ˜¾ç¤ºç‚¹å‡»é¡ºåº
                }
            }
        });
    }

    function updateUI() {
        els.countDisplay.textContent = selectedQueue.length;
    }

    // --- å¯¼å‡ºé€»è¾‘ ---
    async function exportPDF() {
        if (selectedQueue.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡µ');

        const newPdf = await PDFLib.PDFDocument.create();
        
        // æ ¸å¿ƒå·®å¼‚ï¼šæ ¹æ®æ¨¡å¼å†³å®šå¦‚ä½•å¤„ç† selectedQueue
        let finalPages = [];
        
        if (exportMode === 'origin') {
            // å¤åˆ¶ä¸€ä»½ï¼Œç„¶åæŒ‰æ•°å­—å¤§å°æ’åº (1, 5, 10...)
            finalPages = [...selectedQueue].sort((a, b) => a - b);
        } else {
            // ä¿æŒç‚¹å‡»é¡ºåº (10, 1, 5...)
            finalPages = selectedQueue;
        }

        // è½¬æ¢ä¸º 0-based ç´¢å¼•
        const indices = finalPages.map(p => p - 1);
        
        // æ‰¹é‡å¤åˆ¶é¡µé¢
        const copiedPages = await newPdf.copyPages(pdfDoc, indices);
        copiedPages.forEach(page => newPdf.addPage(page));

        const pdfBytes = await newPdf.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        
        const originalName = currentFile.name.replace(/\.pdf$/i, "");
        const suffix = exportMode === 'origin' ? 'æå–' : 'é‡æ’';
        saveAs(blob, `${originalName}_${suffix}.pdf`);
    }
</script>

</body>
</html>
