<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF åˆå¹¶å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --border: #333333;
            --text-main: #e0e0e0;
            --text-dim: #888888;
            --primary: #3b82f6;
            --danger: #ef4444;
            --hover: #2a2a2a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px; /* åˆå¹¶å·¥å…·ä¸éœ€è¦å¤ªå®½ */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* é¡¶éƒ¨å¡ç‰‡ */
        .header-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-info h1 { margin: 0; font-size: 18px; font-weight: 600; }
        .header-info p { margin: 4px 0 0 0; font-size: 12px; color: var(--text-dim); }

        /* æ‹–æ‹½ä¸Šä¼ åŒº */
        .drop-zone {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: #1a1a1a;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }
        .drop-zone:hover, .drop-zone.drag-over { border-color: var(--primary); background: #222; }
        .drop-icon { font-size: 32px; color: #555; margin-bottom: 10px; }
        .drop-hint { color: var(--text-dim); font-size: 14px; }

        /* æ–‡ä»¶åˆ—è¡¨åŒº */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        /* å•ä¸ªæ–‡ä»¶æ¡ç›® */
        .file-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab; /* æç¤ºå¯æ‹–æ‹½ */
            user-select: none;
        }
        
        /* æ‹–æ‹½æ—¶çš„æ ·å¼ */
        .file-item.dragging {
            opacity: 0.5;
            background: #252525;
            border-color: var(--primary);
        }

        .drag-handle {
            color: #555;
            cursor: grab;
            font-size: 18px;
            padding: 0 5px;
        }
        .file-item:hover .drag-handle { color: var(--text-main); }

        .file-info { flex: 1; overflow: hidden; }
        .file-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

        /* æŒ‰é’®ç»„ */
        .action-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-btn:hover { background: var(--hover); color: var(--text-main); }
        .action-btn.delete:hover { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

        /* åº•éƒ¨æ“ä½œæ  */
        .footer-bar {
            position: sticky;
            bottom: 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            z-index: 100;
        }

        button.primary {
            background: var(--primary); 
            color: white; 
            border: none;
            padding: 10px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            transition: background 0.2s;
        }
        button.primary:hover { background: #2563eb; }
        button.primary:disabled { background: #333; color: #666; cursor: not-allowed; }

        .btn-text {
            background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 13px;
        }
        .btn-text:hover { color: var(--text-main); }

        /* ç®€å•çš„åŠ è½½åŠ¨ç”» */
        .spinner {
            border: 2px solid rgba(255,255,255,0.1);
            border-left-color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="header-info">
            <h1>PDF åˆå¹¶å·¥å…·</h1>
            <p>æ‹–æ‹½æ’åº Â· çŸ¢é‡æ— æŸåˆå¹¶ Â· çº¯æœ¬åœ°è¿è¡Œ</p>
        </div>
        <button class="btn-text" onclick="document.getElementById('file-input').click()">+ æ·»åŠ æ–‡ä»¶</button>
    </div>

    <!-- æ‹–æ‹½åŒº -->
    <div id="drop-zone" class="drop-zone">
        <div class="drop-icon">ğŸ“‚</div>
        <div class="drop-hint">ç‚¹å‡»æ·»åŠ æˆ–å°†å¤šä¸ª PDF æ‹–å…¥æ­¤å¤„</div>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">æ”¯æŒå¤šé€‰æ‰¹é‡ä¸Šä¼ </div>
    </div>
    <input type="file" id="file-input" style="display:none" accept=".pdf" multiple>

    <!-- æ–‡ä»¶åˆ—è¡¨å®¹å™¨ -->
    <div id="file-list" class="file-list"></div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="footer-bar">
        <div style="font-size: 13px; color: #888;">
            å…± <b id="total-files" style="color: var(--text-main)">0</b> ä¸ªæ–‡ä»¶ 
            <span style="margin: 0 5px">Â·</span>
            é¢„è®¡ <b id="total-pages" style="color: var(--text-main)">0</b> é¡µ
        </div>
        <button id="merge-btn" class="primary" onclick="mergePDFs()" disabled>å¼€å§‹åˆå¹¶</button>
    </div>
</div>

<script>
    const els = {
        drop: document.getElementById('drop-zone'),
        input: document.getElementById('file-input'),
        list: document.getElementById('file-list'),
        totalFiles: document.getElementById('total-files'),
        totalPages: document.getElementById('total-pages'),
        mergeBtn: document.getElementById('merge-btn')
    };

    // å­˜å‚¨æ–‡ä»¶å¯¹è±¡çš„æ•°ç»„
    // ç»“æ„: { id: string, file: File, pageCount: number }
    let fileQueue = [];
    
    // --- æ‹–æ‹½ä¸ä¸Šä¼ äº‹ä»¶ ---
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
        document.body.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
    });
    
    els.drop.addEventListener('dragover', () => els.drop.classList.add('drag-over'));
    els.drop.addEventListener('dragleave', () => els.drop.classList.remove('drag-over'));
    
    els.drop.addEventListener('drop', (e) => {
        els.drop.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });
    
    els.input.addEventListener('change', (e) => {
        handleFiles(e.target.files);
        // æ¸…ç©º input å…è®¸é‡å¤é€‰æ‹©åŒåæ–‡ä»¶
        els.input.value = ''; 
    });

    els.drop.onclick = () => els.input.click();

    // --- æ ¸å¿ƒé€»è¾‘ï¼šæ–‡ä»¶å¤„ç† ---
    async function handleFiles(fileList) {
        if (!fileList.length) return;

        // ä¸´æ—¶ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢å¿«é€Ÿæ“ä½œ
        els.mergeBtn.disabled = true;
        els.mergeBtn.textContent = 'è§£æä¸­...';

        for (let file of fileList) {
            if (file.type !== 'application/pdf') continue;

            try {
                // é¢„è§£æä»¥è·å–é¡µæ•°ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
                // è¿™é‡ŒåªåŠ è½½å¤´éƒ¨ä¿¡æ¯ï¼Œæ¯”å®Œå…¨æ¸²æŸ“å¿«å¾—å¤š
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
                const pageCount = pdfDoc.getPageCount();

                const fileObj = {
                    id: Math.random().toString(36).substr(2, 9),
                    file: file,
                    pageCount: pageCount
                };

                fileQueue.push(fileObj);
                renderFileItem(fileObj);

            } catch (err) {
                console.error("è§£æå¤±è´¥:", file.name, err);
                alert(`æ— æ³•è§£ææ–‡ä»¶ ${file.name}ï¼Œå¯èƒ½æ˜¯åŠ å¯†æ–‡æ¡£æˆ–å·²æŸåã€‚`);
            }
        }

        updateStats();
        resetMergeBtn();
    }

    // --- UI æ¸²æŸ“ï¼šåˆ—è¡¨é¡¹ ---
    function renderFileItem(fileObj) {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.draggable = true; // å¼€å¯åŸç”Ÿæ‹–æ‹½
        div.dataset.id = fileObj.id;

        // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
        const size = (fileObj.file.size / 1024 / 1024).toFixed(2) + ' MB';

        div.innerHTML = `
            <div class="drag-handle">â˜°</div>
            <div class="file-info">
                <div class="file-name" title="${fileObj.file.name}">${fileObj.file.name}</div>
                <div class="file-meta">${fileObj.pageCount} é¡µ Â· ${size}</div>
            </div>
            <button class="action-btn" onclick="moveItem('${fileObj.id}', -1)" title="ä¸Šç§»">â†‘</button>
            <button class="action-btn" onclick="moveItem('${fileObj.id}', 1)" title="ä¸‹ç§»">â†“</button>
            <button class="action-btn delete" onclick="removeItem('${fileObj.id}')" title="ç§»é™¤">âœ•</button>
        `;

        // ç»‘å®šæ‹–æ‹½äº‹ä»¶
        addDragEvents(div);
        
        els.list.appendChild(div);
    }

    // --- äº¤äº’ï¼šåˆ—è¡¨æ’åºä¸ç®¡ç† ---

    function removeItem(id) {
        fileQueue = fileQueue.filter(f => f.id !== id);
        const el = document.querySelector(`.file-item[data-id="${id}"]`);
        if (el) el.remove();
        updateStats();
    }

    function moveItem(id, direction) {
        const idx = fileQueue.findIndex(f => f.id === id);
        if (idx === -1) return;
        
        const newIdx = idx + direction;
        if (newIdx < 0 || newIdx >= fileQueue.length) return;

        // äº¤æ¢æ•°æ®
        [fileQueue[idx], fileQueue[newIdx]] = [fileQueue[newIdx], fileQueue[idx]];
        
        // äº¤æ¢ DOM
        renderAllList();
    }

    // é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨ï¼ˆç”¨äºæ’åºååˆ·æ–° DOMï¼‰
    function renderAllList() {
        els.list.innerHTML = '';
        fileQueue.forEach(obj => renderFileItem(obj));
        updateStats();
    }

    function updateStats() {
        els.totalFiles.textContent = fileQueue.length;
        const totalP = fileQueue.reduce((acc, cur) => acc + cur.pageCount, 0);
        els.totalPages.textContent = totalP;
        
        els.mergeBtn.disabled = fileQueue.length < 2;
    }

    function resetMergeBtn() {
        els.mergeBtn.textContent = 'å¼€å§‹åˆå¹¶';
        if (fileQueue.length >= 2) els.mergeBtn.disabled = false;
    }

    // --- æ‹–æ‹½æ’åºé€»è¾‘ (Native API) ---
    let dragSrcEl = null;

    function addDragEvents(item) {
        item.addEventListener('dragstart', function(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        });

        item.addEventListener('dragover', function(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        });

        item.addEventListener('dragenter', function() {
            this.classList.add('drag-over');
        });

        item.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });

        item.addEventListener('drop', function(e) {
            if (e.stopPropagation) e.stopPropagation();
            
            if (dragSrcEl !== this) {
                // DOM äº¤æ¢ä½ç½®é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œç®€å•ç²—æš´çš„æ–¹æ³•æ˜¯
                // 1. è·å–æº ID å’Œ ç›®æ ‡ ID
                const srcId = dragSrcEl.dataset.id;
                const targetId = this.dataset.id;
                
                // 2. åœ¨æ•°ç»„ä¸­é‡æ–°æ’åº
                const srcIdx = fileQueue.findIndex(f => f.id === srcId);
                const targetIdx = fileQueue.findIndex(f => f.id === targetId);
                
                const [movedItem] = fileQueue.splice(srcIdx, 1);
                fileQueue.splice(targetIdx, 0, movedItem);
                
                // 3. é‡ç»˜
                renderAllList();
            }
            return false;
        });

        item.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('drag-over'));
        });
    }


    // --- æ ¸å¿ƒé€»è¾‘ï¼šåˆå¹¶å¯¼å‡º ---
    async function mergePDFs() {
        if (fileQueue.length < 2) return;

        const originalText = els.mergeBtn.textContent;
        els.mergeBtn.innerHTML = '<span class="spinner"></span>å¤„ç†ä¸­...';
        els.mergeBtn.disabled = true;

        try {
            // 1. åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºæ–‡æ¡£
            const mergedPdf = await PDFLib.PDFDocument.create();

            // 2. éå†é˜Ÿåˆ—
            for (const fileObj of fileQueue) {
                const arrayBuffer = await fileObj.file.arrayBuffer();
                const srcDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                // 3. å¤åˆ¶æ‰€æœ‰é¡µé¢
                // copyPages å®ç°äº†åº•å±‚å¯¹è±¡çš„æµå¤åˆ¶ï¼Œä¿ç•™çŸ¢é‡ã€å­—ä½“å’Œé“¾æ¥
                const indices = srcDoc.getPageIndices();
                const copiedPages = await mergedPdf.copyPages(srcDoc, indices);
                
                // 4. å°†å¤åˆ¶çš„é¡µé¢æ·»åŠ åˆ°æ–°æ–‡æ¡£
                copiedPages.forEach(page => mergedPdf.addPage(page));
            }

            // 5. ä¿å­˜å¹¶ä¸‹è½½
            const pdfBytes = await mergedPdf.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            
            // è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶åï¼šåˆ©ç”¨ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„åå­— + "_åˆå¹¶"
            const firstName = fileQueue[0].file.name.replace(/\.pdf$/i, "");
            saveAs(blob, `${firstName}ç­‰${fileQueue.length}ä¸ªæ–‡ä»¶_åˆå¹¶.pdf`);

            alert('åˆå¹¶æˆåŠŸï¼');

        } catch (err) {
            console.error(err);
            alert('åˆå¹¶è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å®Œæ•´ã€‚');
        } finally {
            resetMergeBtn();
        }
    }
</script>

</body>
</html>
